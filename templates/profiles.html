<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
  <title>NNCS 補習班學生資訊系統</title>
  <link rel="icon" href="assets/img/NNCS_Matting.png" type="image/png type">

  <!-- General CSS Files -->
  <link rel="stylesheet" href="assets/modules/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/modules/fontawesome/css/all.min.css">

  <!-- CSS Libraries -->
  <link rel="stylesheet" href="assets/modules/jqvmap/dist/jqvmap.min.css">
  <link rel="stylesheet" href="assets/modules/weather-icon/css/weather-icons.min.css">
  <link rel="stylesheet" href="assets/modules/weather-icon/css/weather-icons-wind.min.css">
  <link rel="stylesheet" href="assets/modules/summernote/summernote-bs4.css">

  <!-- Template CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/components.css">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- 加载 Google API 客户端库 -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- Start GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-94034622-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-94034622-3');
  </script>
  <!-- /END GA -->
</head>
<body>
  <div id="app">
    <div class="main-wrapper main-wrapper-1">
      <div class="navbar-bg" style="height: 70px;"></div>
      <nav class="navbar navbar-expand-lg main-navbar">
        <form class="form-inline mr-auto">
          <ul class="navbar-nav mr-3">
            <li><a href="#" data-toggle="sidebar" class="nav-link nav-link-lg"><i class="fas fa-bars"></i></a></li>
          </ul>
        </form>
        <ul class="navbar-nav navbar-right">
          <li class="dropdown"><a href="#" data-toggle="dropdown"
              class="nav-link dropdown-toggle  nav-link-lg nav-link-user">
              <!-- <img alt="image" src={{session['photo']}} class="rounded-circle mr-1"> -->
              <img alt="image" src="{{picture}}" class="rounded-circle mr-1">
              <div class="d-sm-none d-lg-inline-block">{{name}}</div>
            </a>
            <div class="dropdown-menu dropdown-menu-right">
              <div class="dropdown-title" style="text-transform: none; margin: 0px 8px; font-size: 13px;">Hi,{{name}}!</div>
              <div class="dropdown-divider" style="border-top-color: #868e96;"></div>
              <a href="{{ url_for('logout') }}"  class="dropdown-item has-icon text-danger">
                <i class="fas fa-sign-out-alt"></i> Logout
              </a>
            </div>
          </li>
        </ul>
      </nav>
      <div class="main-sidebar sidebar-style-2">
        <aside id="sidebar-wrapper">
          <div class="sidebar-brand">
            <a>NNCS-補習班學生資訊系統</a>
          </div>
          <div class="sidebar-brand sidebar-brand-sm">
            <a href="index"><img src="assets/img/NNCS_Matting.png" height="40px" width="40px"></a>
          </div>
          <ul class="sidebar-menu">
            <li class="menu-header">學生資訊</li>
            <li class=active><a href="{{ url_for('profiles') }}" class="nav-link"><i
                  class="fas fa-id-badge"></i><span>個人檔案</span></a></li>
            <li><a href="{{ url_for('index') }}" class="nav-link"><i
                  class="fas fa-calendar-alt"></i><span>我的課表</span></a></li>
            <li><a href="{{ url_for('certificate') }}" class="nav-link"><i
              class="fas fa-trophy"></i><span>我的證照</span></a></li>
            <li><a href="{{ url_for('st_note') }}" class="nav-link"><i
              class="fas fa-book"></i><span>學習紀錄</span></a></li>
          </ul>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <section class="section">
          <br>
          <!-- <div class="section-header">
            <h1>Dashboard</h1>
          </div> -->
          <!-- <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
              <div class="card card-statistic-1">
                <div class="card-icon bg-primary">
                  <i class="far fa-user"></i>
                </div>
                <div class="card-wrap">
                  <div class="card-header">
                    <h4>Total Admin</h4>
                  </div>
                  <div class="card-body">
                    10
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
              <div class="card card-statistic-1">
                <div class="card-icon bg-danger">
                  <i class="far fa-newspaper"></i>
                </div>
                <div class="card-wrap">
                  <div class="card-header">
                    <h4>News</h4>
                  </div>
                  <div class="card-body">
                    42
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
              <div class="card card-statistic-1">
                <div class="card-icon bg-warning">
                  <i class="far fa-file"></i>
                </div>
                <div class="card-wrap">
                  <div class="card-header">
                    <h4>Reports</h4>
                  </div>
                  <div class="card-body">
                    1,201
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
              <div class="card card-statistic-1">
                <div class="card-icon bg-success">
                  <i class="fas fa-circle"></i>
                </div>
                <div class="card-wrap">
                  <div class="card-header">
                    <h4>Online Users</h4>
                  </div>
                  <div class="card-body">
                    47
                  </div>
                </div>
              </div>
            </div>
          </div> -->

          <div class="card profile-widget" style="margin-top: 15px;">
            <div class="profile-widget-header">
              <img alt="image" src="{{picture}}" class="rounded-circle profile-widget-picture">
              <div class="profile-widget-items">
                <div class="profile-widget-item">
                  <div class="profile-widget-item-label">課程</div>
                  <div class="profile-widget-item-value" style="font-size: 14px;">{{course_name}}</div>
                </div>
                <div class="profile-widget-item">
                  <div class="profile-widget-item-label">請假/缺課</div>
                  <div class="profile-widget-item-value">{{leave_num}}</div>
                </div>
                <div class="profile-widget-item">
                  <div class="profile-widget-item-label">已上課堂數</div>
                  <div class="profile-widget-item-value">{{class_num}}/20</div>
                </div>
              </div>
            </div>
            <div class="profile-widget-description">
              <div class="profile-widget-name">{{name}}<div class="text-muted d-inline font-weight-normal">
                  【{{role}}】/ {{session['user_id']}}</div>
              </div>
              <div class="row">
                <div class="form-group col-md-6 col-12">
                  <label>聯絡電話-1</label>
                  <input type="text" class="form-control" name="phone1" value="{{phone1}}" readonly
                    style="pointer-events: none; background-color: #efeeee; border: none;">
                </div>
                <div class="form-group col-md-6 col-12">
                  <label>聯絡電話-2</label>
                  <input type="text" class="form-control" name="phone2" value="{{phone2}}" readonly
                    style="pointer-events: none; background-color: #efeeee; border: none;">
                </div>
                <div class="form-group col-md-6 col-12">
                  <label>Email</label>
                  <input type="text" class="form-control" name="email" value="{{email}}" readonly
                    style="pointer-events: none; background-color: #efeeee; border: none;">
                </div>
                <div class="form-group col-md-6 col-12">
                  <label>聯絡住址</label>
                  <input type="text" class="form-control" name="address" value="{{address}}" readonly
                    style="pointer-events: none; background-color: #efeeee; border: none;">
                </div>
                <div class="form-group col-md-6 col-12">
                  <label>就讀學校/就業公司</label>
                  <input type="text" class="form-control" name="workplace" value="{{workplace}}" readonly
                    style="pointer-events: none; background-color: #efeeee; border: none;">
                </div>
                <div class="form-group col-md-6 col-12">
                  <label>職業</label>
                  <input type="text" class="form-control" name="profession" value="{{profession}}" readonly
                    style="pointer-events: none; background-color: #efeeee; border: none;">
                </div> 
              </div>
            </div>
            <div class="card-footer text-right">
              <script>
                picture = {{ picture| tojson | safe}};
                name = {{ name| tojson | safe}};
                address = {{ address| tojson | safe}};
                phone1 = {{ phone1| tojson | safe}};
                phone2 = {{ phone2| tojson | safe}};
                email = {{ email| tojson | safe}};
                workplace = {{ workplace| tojson | safe}};
                profession = {{ profession| tojson | safe}};
              </script>
              
              <button class="btn btn-primary" id="updateDataButton">更新資料</button>
            </div>
          </div>

          <div class="row">
            <div class="col-lg-6 col-md-12 col-12 col-sm-12">
              <div class="card" style="height: calc(100% - 30px);">
                <div class="card-header">
                  <h4>出席統計</h4>
                </div>
                <div class="card-body">
                  <script>
                    var class_num = {{class_num | tojson | safe}}
                    var start_class_date = {{start_class_date | tojson | safe}}
                    var end_class_date = {{end_class_date | tojson | safe}}
                    var attend_data = {{attend_data| tojson | safe}};
                    console.log('aaa', attend_data);
                    var attendanceCounts = {};

                    attend_data.forEach(function(item) {
                        attendanceCounts[item.status] = (attendanceCounts[item.status] || 0) + 1;
                    });

                  </script>
                  <canvas id="myChart_1"></canvas>
                  <br><br>
                  <canvas id="myChart_2"></canvas>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card" style="height: calc(100% - 30px);">
                <div class="card-header">
                  <h4>出席明細</h4>
                  <div class="card-header-action dropdown">
                    <a data-toggle="dropdown" class="btn btn-danger dropdown-toggle" id="dropdownMenuButton" 
                    style="color: white;">全部</a>
                    <ul class="dropdown-menu dropdown-menu-sm dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                      <li class="dropdown-title">選擇類別</li>
                      <li><a class="dropdown-item active" onclick="updateDropdown(this, '全部')">全部</a></li>
                      <li><a class="dropdown-item" onclick="updateDropdown(this, '上課')">上課</a></li>
                      <li><a class="dropdown-item" onclick="updateDropdown(this, '請假')">請假</a></li>
                      <li><a class="dropdown-item" onclick="updateDropdown(this, '曠課')">曠課</a></li>
                      <li><a class="dropdown-item" onclick="updateDropdown(this, '停課')">停課</a></li>
                    </ul>
                  </div>
                </div>
                <div class="card-body" id="top-5-scroll" style="padding-top: inherit;">
                  <table class="table table-striped" id="attend-table">
                    <thead style="position: sticky; top: 0; background-color: white; z-index: 1;">
                      <tr>
                        <th>日期</th>
                        <th>教室</th>
                        <th>時間</th>
                        <th>狀態</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- 用JS顯示篩選後的出席紀錄 -->
                    </tbody>
                  </table>
                </div>
                <div class="card-footer" id="attendance-footer">
                  <div class="text-muted">本學期累積次數：<span id="attendance-count">0</span> 次</div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
      <footer class="main-footer">
        <div class="footer-left">
          組別: 113201 指導老師 : 林俊杰老師 &nbsp 專題組員: 11236001 林奕辰
        </div>
        <div class="footer-right"></div>
      </footer>
    </div>
  </div>

  <script>
    var client_id = "346287506808-oe0cu9l0ovsie49b274hhkrmmsr4ih0v.apps.googleusercontent.com",
      Key = "AIzaSyB63lPx97CBNrxTAli8oz1A3n3_olyirq8",
      scope = "https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/user.gender.read https://www.googleapis.com/auth/user.birthday.read",
      personFields = "names,emailAddresses,photos,genders,birthdays",
      discovery_doc = "https://www.googleapis.com/discovery/v1/apis/people/v1/rest",
      resourceName = "people/me",
      $personal_info = $("#personal_info"),
      redirect_uri = "https://79ea-219-70-149-68.ngrok-free.app",
      tokenClient;

    loadApi();

    // 載入 Google API
    function loadApi() {
      // 載入 gapi
      $.getScript("https://apis.google.com/js/api.js", function () {
        gapi.load("client", function () {
          gapi.client.init({
            apiKey: Key,
            discoveryDocs: [discovery_doc],
          });
        });
      });

      // 載入 gsi
      $.getScript("https://accounts.google.com/gsi/client", function () {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: client_id,
          scope: scope,
          callback: signIn_callback,
          error_callback: error_callback,
          redirect_uri: redirect_uri
        });
      });
    }

    // 登入成功後 callback
    function signIn_callback(res) {
      if (res && res.access_token) {
        var login_status = "True";
        var login_method = "google";
        var access_token = res.access_token;
        $.ajax({
          type: "POST",
          url: "/login",
          data: { login_status: login_status, login_method: login_method, access_token: access_token },
          success: function (response) {
            window.location.href = "/profiles";
          },
          error: function (error) {
            console.error("Error loading:", error);
          }
        });
      }
    }

    // 捕捉非 OAuth 錯誤 或是在傳回 OAuth 回應前遭到關閉
    function error_callback(res) {
      console.log(res);
      $personal_info.html(res.message);
    }

    // 點擊登入按鈕
    $("#google_login").click(function () {
      // 進動畫
      $personal_info.html("<img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgATuJvkpy3TyBQtXW_JJ59fpiTcu6m9jkBoXtHXpCwpiiOqDdLSLIP2VkH56AQHEg_JubYb6aueZcHrVC-1muR1XwNF3Fxkt_fbNxdMtl6TiakzPHvqPlXefdZMOu2u9IzU6-a-X8So4ok/s512/indicator-light.gif' /> <span>請稍後...</span>");

      if (gapi.client.getToken() === null) {
        // 未登入則彈出登入視窗
        tokenClient.requestAccessToken();
      } else {
        // 已登入則不彈出視窗
        tokenClient.requestAccessToken({
          prompt: ""
        });
      }
    });

    $("#google_logout").click(function () {
      $.ajax({
        type: "GET",
        url: "/logout",
        success: function () {
          // 清除浏览器的缓存
          window.location.href = "/login";
          window.location.reload(true);
        },
        error: function (error) {
          console.error("Logout error:", error);
        }
      });
    });
  </script>

  <!-- General JS Scripts -->
  <script src="assets/modules/jquery.min.js"></script>
  <script src="assets/modules/popper.js"></script>
  <script src="assets/modules/tooltip.js"></script>
  <script src="assets/modules/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/modules/nicescroll/jquery.nicescroll.min.js"></script>
  <script src="assets/modules/moment.min.js"></script>
  <script src="assets/js/stisla.js"></script>

  <!-- JS Libraies -->
  <script src="assets/modules/simple-weather/jquery.simpleWeather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.1/dist/chart.umd.min.js"></script>
  <script src="assets/modules/chart.min.js"></script>

  <script src="assets/modules/jqvmap/dist/jquery.vmap.min.js"></script>
  <script src="assets/modules/jqvmap/dist/maps/jquery.vmap.world.js"></script>
  <script src="assets/modules/summernote/summernote-bs4.js"></script>
  <script src="assets/modules/chocolat/dist/js/jquery.chocolat.min.js"></script>

  <!-- Page Specific JS File -->
  <script src="assets/js/page/bootstrap-modal.js"></script>
  <script src="assets/js/page/profiles.js"></script>

  <!-- Template JS File -->
  <script src="assets/js/scripts.js"></script>
  <script src="assets/js/custom.js"></script>
</body>

</html>